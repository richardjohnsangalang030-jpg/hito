#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include "DHT.h"
#include <ESP32Servo.h>
#include <WiFiUdp.h>
#include <NTPClient.h>
#include <OneWire.h>
#include <DallasTemperature.h>

/* ===================== WIFI ===================== */
#define WIFI_SSID "HGW-F80D35"
#define WIFI_PASSWORD "12345678"

/* ===================== FIREBASE ===================== */
#define API_KEY "AIzaSyB2QxCK3CFtCQN-66Ro2SF2jFSkEzE2kNc"
#define DATABASE_URL "https://hito-monitoring-default-rtdb.firebaseio.com"
#define USER_EMAIL "richardjohnsangalang030@gmail.com"
#define USER_PASSWORD "09099603909"

/* ===================== PINS ===================== */
#define DHTPIN 4
#define DHTTYPE DHT22
#define PH_SENSOR_PIN 34
#define ONE_WIRE_BUS 27
#define SERVO_PIN 25
#define RELAY1_PIN 26 // Turbidity cleaning relay
#define RELAY2_PIN 14 // Scheduled cleaning relay
#define TURBIDITY_PIN 32 // Analog pin for turbidity sensor

/* ===================== OBJECTS ===================== */
DHT dht(DHTPIN, DHTTYPE);
Servo feederServo;
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature waterTempSensor(&oneWire);

FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "pool.ntp.org", 8 * 3600, 60000);

/* ===================== VARIABLES ===================== */
float airTemp, humidity, pHValue, waterTemp;
int read_ADC, ntu;
String waterQualityStatus;

/* ===================== FEEDING ===================== */
int feedHour1 = 9;   // 9:00 AM
int feedHour2 = 21;  // 9:00 PM
int feedMinute = 0;
bool hasFedAM = false;
bool hasFedPM = false;

/* ===================== CONTROL MODE ===================== */
String controlMode = "automatic"; // default mode

/* ===================== TIMING ===================== */
unsigned long lastSend = 0;
const unsigned long interval = 3000;

/* ===================== SCHEDULED CLEANING ===================== */
unsigned long lastScheduledOpen = 0;
const unsigned long scheduledInterval = 3UL * 24UL * 3600UL * 1000UL; // 3 days
const unsigned long scheduledDuration = 2UL * 3600UL * 1000UL;          // 2 hours
bool scheduledActive = false;
unsigned long scheduledStartTime = 0;

/* ===================== SETUP ===================== */
void setup() {
  Serial.begin(115200);
  dht.begin();
  waterTempSensor.begin();
  feederServo.attach(SERVO_PIN);
  feederServo.write(0);

  pinMode(RELAY1_PIN, OUTPUT);
  pinMode(RELAY2_PIN, OUTPUT);
  pinMode(TURBIDITY_PIN, INPUT);

  digitalWrite(RELAY1_PIN, HIGH);
  digitalWrite(RELAY2_PIN, HIGH);

  /* ===== WiFi ===== */
  Serial.print("Connecting to WiFi");
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ WiFi CONNECTED");

  /* ===== Firebase ===== */
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  Serial.print("Connecting to Firebase");
  unsigned long fbStart = millis();
  while (!Firebase.ready()) {
    Serial.print(".");
    delay(300);
    if (millis() - fbStart > 10000) {
      Serial.println("\n‚ùå Firebase connection FAILED");
      return;
    }
  }
  Serial.println("\n‚úÖ Firebase CONNECTED");

  timeClient.begin();
}

/* ===================== LOOP ===================== */
void loop() {
  timeClient.update();
  unsigned long nowMillis = millis();
  int currentHour = timeClient.getHours();
  int currentMinute = timeClient.getMinutes();

  /* ===== Firebase status check ===== */
  static unsigned long lastFBCheck = 0;
  if (millis() - lastFBCheck > 10000) {
    lastFBCheck = millis();
    if (Firebase.ready())
      Serial.println("‚úÖ Firebase still connected");
    else
      Serial.println("‚ùå Firebase disconnected");
  }

  /* ===== Read control mode from Firebase ===== */
  if (Firebase.RTDB.getString(&fbdo, "/HitoFarm/ControlMode")) {
    controlMode = fbdo.stringData();
  } else {
    Serial.println("‚ùå Failed to read ControlMode");
  }

  /* ===== Turbidity reading ===== */
  int rawADC = analogRead(TURBIDITY_PIN);
  read_ADC = map(rawADC, 0, 4095, 0, 4095);
  ntu = map(read_ADC, 0, 4095, 300, 10); // calibrated NTU

  // Automatic relay control if in automatic mode
  if (controlMode == "automatic") {
    if (ntu <= 50) {
      digitalWrite(RELAY1_PIN, HIGH); // OFF
      waterQualityStatus = "OFF";
    } else {
      digitalWrite(RELAY1_PIN, LOW);  // ON
      waterQualityStatus = "OPEN";
    }
  } else {
    waterQualityStatus = "MANUAL";
  }

  Serial.print("üåä Turbidity NTU: ");
  Serial.print(ntu);
  Serial.print(" | Status: ");
  Serial.println(waterQualityStatus);

  /* ===== Scheduled cleaning (Relay 2) ===== */
  if (!scheduledActive && (nowMillis - lastScheduledOpen >= scheduledInterval)) {
    scheduledActive = true;
    scheduledStartTime = nowMillis;
    digitalWrite(RELAY2_PIN, LOW);
    lastScheduledOpen = nowMillis;
    Serial.println("üïí Scheduled cleaning STARTED");
  }
  if (scheduledActive && (nowMillis - scheduledStartTime >= scheduledDuration)) {
    scheduledActive = false;
    digitalWrite(RELAY2_PIN, HIGH);
    Serial.println("üïí Scheduled cleaning STOPPED");
  }

  /* ===== Read & Send ===== */
  if (nowMillis - lastSend >= interval) {
    lastSend = nowMillis;
    readSensors();
    sendToFirebase();
  }

  /* ===== Manual Buttons from Firebase ===== */
  if (controlMode == "manual") {
    // Feed
    if (Firebase.RTDB.getBool(&fbdo, "/HitoFarm/Manual/Feed") && fbdo.boolData()) {
      feedFish();
      Serial.println("üêü Fish FED (manual)");
      Firebase.RTDB.setBool(&fbdo, "/HitoFarm/Manual/Feed", false); // reset
    }

    // Valve toggle
    if (Firebase.RTDB.getBool(&fbdo, "/HitoFarm/Manual/Relay1Toggle") && fbdo.boolData()) {
      digitalWrite(RELAY1_PIN, !digitalRead(RELAY1_PIN)); // toggle
      Serial.println("üíß Valve toggled (manual)");
      Firebase.RTDB.setBool(&fbdo, "/HitoFarm/Manual/Relay1Toggle", false); // reset
    }
  }

  /* ===== Automatic Feeding ===== */
  if (controlMode == "automatic") {
    if (currentHour == feedHour1 && currentMinute == feedMinute && !hasFedAM) {
      feedFish();
      hasFedAM = true;
      Serial.println("üêü Fish FED (AM)");
    }
    if (currentHour == feedHour2 && currentMinute == feedMinute && !hasFedPM) {
      feedFish();
      hasFedPM = true;
      Serial.println("üêü Fish FED (PM)");
    }
    // Reset at midnight
    if (currentHour == 0 && currentMinute == 0) {
      hasFedAM = false;
      hasFedPM = false;
    }
  }

  delay(1000);
}

/* ===================== READ SENSORS ===================== */
void readSensors() {
  airTemp = dht.readTemperature();
  humidity = dht.readHumidity();

  waterTempSensor.requestTemperatures();
  waterTemp = waterTempSensor.getTempCByIndex(0);

  int phRaw = analogRead(PH_SENSOR_PIN);
  float phVoltage = phRaw * (3.3 / 4095.0);
  pHValue = 2.3 * phVoltage; // adjust calibration

  Serial.println("üìä Sensors Updated");
}

/* ===================== FIREBASE ===================== */
void sendToFirebase() {
  if (!Firebase.ready()) {
    Serial.println("‚ùå Firebase not ready, data NOT sent");
    return;
  }

  bool ok = true;
  ok &= Firebase.RTDB.setFloat(&fbdo, "/HitoFarm/WaterQuality/AirTemperature", airTemp);
  ok &= Firebase.RTDB.setFloat(&fbdo, "/HitoFarm/WaterQuality/Humidity", humidity);
  ok &= Firebase.RTDB.setFloat(&fbdo, "/HitoFarm/WaterQuality/WaterTemperature", waterTemp);
  ok &= Firebase.RTDB.setFloat(&fbdo, "/HitoFarm/WaterQuality/pH", pHValue);
  ok &= Firebase.RTDB.setInt(&fbdo, "/HitoFarm/WaterQuality/TurbidityNTU", ntu);
  ok &= Firebase.RTDB.setString(&fbdo, "/HitoFarm/Status/WaterQuality", waterQualityStatus);

  if (ok) {
    Serial.println("‚úÖ Data SENT to Firebase");
  } else {
    Serial.print("‚ùå Firebase ERROR: ");
    Serial.println(fbdo.errorReason());
  }
}

/* ===================== FEEDING ===================== */
void feedFish() {
  feederServo.write(180);
  delay(1000);
  feederServo.write(0);
}
